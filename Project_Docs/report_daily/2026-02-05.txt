오늘의 업무: 백엔드 리팩토링 (아키텍처 레이어 분리 및 SQL 중심 패턴 강화)

1. 현재 프로젝트 구조 분석 및 리팩토링 대상 파악
   - Router, Service, Repository 레이어 분리 상태 확인
   - ORM 사용처를 Schema/Migration으로 제한하고 CRUD는 Raw SQL로 전환

2. Smart Security 기술 표준(Skill) 점검 및 업데이트
   - Router -> Service -> Repository 구조 명시화
   - Raw SQL 헬퍼 활용 가이드 강화

3. 백엔드 핵심 모듈 리팩토링 진행
   - Worker, Project, Attendance 등 주요 도메인 로직 고도화

4. 작업 결과 검증
   - API 동작 테스트 및 로그 확인
   - 구조적 정합성 검증

===
오후 (작업 마무리):
1. 백엔드 아키텍처 전면 리팩토링 완료 (Router - Service - Repository 3계층 분리)
2. 핵심 모듈 (Project, Attendance, Notice, Company, Safety, Work)에 SQL-First Repository 패턴 적용
3. AsyncSession 의존성 제거 및 back.database의 Raw SQL 헬퍼 함수로 전면 교체
4. API 엔드포인트 접두어 (/api)를 main.py에서 중앙 집중식으로 관리하도록 통일
5. 기술 표준 문서 (sql_repository_pattern) 최신화 완료
6. 특이사항: 프로젝트 전체의 데이터 무결성 및 성능 최적화를 위한 구조 개선 성공

===
[CEO 요구사항 분석 및 현황] - 2026-02-05
1. 위험 구역 지도 MVP: 기능 구현됨. 날짜별/구역별 위험 요소 등록 가능. (지도 UI 드래그 배치 등 고도화 필요)
2. 작업자 맞춤형 위험 Zone: 구현됨. 작업자 대시보드에서 본인 배정 구역 위험 요소를 필터링하여 노출.
3. Hazard Pin (참여형): 플레이스홀더 상태. 작업자용 위험 신고 및 지도 핀 등록 기능 개발 필요.
4. Safety Brief: 구현됨. 공정별 안전 수칙 자동 생성 및 노출. (작업 시작 승인 프로세스 고도화 필요)

익일 진행 계획:
1. 리팩토링된 API들에 대한 통합 테스트 및 404 에러 최종 수정
2. 프론트엔드 연동 확인 및 필요 시 조정
3. Hazard Pin 기능 개발 착수 (DB 설계 및 API 구현)

===
[오후 추가 작업] - 지도 UI 개선 및 위험구역 신고 기능 설계

1. 지도 컴포넌트 통합 완료
   - WorkerWorkSiteMap 제거, UniversalBlueprintMap으로 전체 통합
   - Worker/Manager/Admin 모든 플랫폼에서 단일 컴포넌트 사용
   - 지도 투명도 통합 관리 (MAP_TILE_OPACITY = 0.15)

2. 위험구역 표시 스타일 개선
   - 위험구역: 빨강 테두리만 표시 (색칠 제거, weight: 3)
   - 작업구역: 파랑 색칠 + 테두리
   - 겹침 구역: 파랑 색칠 + 빨강 테두리

3. 백엔드 SQL Repository 패턴 위반 수정
   - worker/service.py의 생 SQL → SafetyRepository.get_zones_by_project_id() 이동

4. 위험구역 신고(Hazard Report) 기능 요구사항 정리
   [근로자 앱]
   - 지도 상단에 "신고 모드" 토글 + 사이렌 아이콘 추가
   - 신고 모드 활성화 시 구역 클릭 → 신고 폼 표시
   - 신고 내용: 제목, 상세내용, 사진 업로드
   - 신고된 구역: 지도에서 주황색 점선 테두리로 표시 (pending 상태)
   
   [현장관리자 앱]
   - 신고 목록 화면 추가 (미승인/승인/거부)
   - 신고 상세 보기: 제목, 내용, 사진, 신고자, 신고일시, 구역정보
   - 승인 버튼 클릭 → daily_danger_zones에 자동 등록 (빨강 테두리로 전환)
   - 거부 버튼 클릭 → 신고 상태만 변경, 지도 표시 제거
   
   [DB 설계]
   - hazard_reports 테이블 생성 필요
     * id, zone_id, reporter_user_id, title, description, image_url
     * status (pending/approved/rejected), created_at, reviewed_at, reviewer_user_id
   
   [구현 순서]
   1. DB 스키마 (alembic migration)
   2. 백엔드 Repository/Service/Router
   3. 이미지 업로드 처리 (back/upload 폴더)
   4. 근로자 신고 UI (지도 클릭 → 폼 → 제출)
   5. 관리자 신고 목록/승인 UI
   6. 지도에 신고 구역 표시 (주황 점선)

===
[CEO 추가 요구사항] - 안전 그리드 시스템 고도화 (2026-02-05)

1. 프로젝트 생성 시 그리드 설정 (최고관리자)
   - 프로젝트 위치 (lat, lng) 지정
   - 그리드 간격 설정 (한 칸 크기)
   - 그리드 격자 개수 설정 (가로 x 세로)
   - 이 단계 생략 가능, 나중에 중간관리자 조정 가능

2. 중간관리자의 안전존 그리드 재설정
   - 프로젝트 위치는 고정 (변경 불가)
   - 그리드 간격과 격자 개수만 조정
   - 기존 zones/작업계획 영향 경고 필수

3. 층수 기반 3D 뷰 (평면도 + 단면도)
   - zones에 floor/level 컬럼 추가 (1F, 2F, B1, ROOF)
   - 평면도 (왼쪽): 선택 층의 그리드
   - 단면도 (오른쪽): 전체 층 구조, 클릭 시 평면도 전환
   - 층별 작업 현황 및 위험도 표시

[기술 설계]
   DB: projects에 grid_spacing/rows/cols 추가
       zones에 floor/grid_x/grid_y 추가
   API: 프로젝트 생성 시 zones 자동 생성
        그리드 재설정 API
        층별 zones 조회 API
   UI: ProjectGridSettings 컴포넌트
       FloorSelector (단면도)
       UniversalBlueprintMap 층별 필터링

[추가 작업 완료] - 안전 그리드 시스템 (x, y, z) 구축 완료 (2026-02-05)

1. DB 마이그레이션 및 스키마 업데이트
   - projects 테이블: grid_spacing, grid_rows, grid_cols 컬럼 추가
   - zones 테이블: grid_x, grid_y, grid_z (층수) 컬럼 추가
   - Alembic ghost revision (d78e4f2a9012) 문제 해결 및 마이그레이션 완료

2. 백엔드 로직 구현
   - SafetyService.generate_grid_for_site: 프로젝트 설정 기반 Zone 자동 생성 로직 구현
   - ProjectService: 프로젝트 생성 시 기본 현장('본현장') 생성 및 그리드 초기화 연동
   - SafetyRouter: /sites/{site_id}/generate-grid 엔드포인트 추가

3. 프론트엔드 UI/UX
   - 최고관리자: 프로젝트 생성 폼에 가로/세로 격자 수 및 간격 설정 UI 추가
   - 중간관리자: '작업 위치 설정' 화면에서 그리드 자동 생성 버튼 및 층별 필터링 기능 구현
   - 지도 연동: 층별 필터링에 따른 지도 및 구역 목록 동기화 완료

[다음 작업]
1. 위험구역 신고 시스템 구현 (근로자 신고 -> 관리자 승인)
2. 3D 뷰 (단면도) UI 컴포넌트 개발
3. Hazard Pin 지도 참여형 기능 구현
