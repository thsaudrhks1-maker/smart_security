==============================================================
03. 프로젝트 중심 아키텍처 (Project-Centric Architecture)
==============================================================

목표
"관리자가 프로젝트를 생성하고 설정을 완료한 후, 작업자들이 사용하는 구조"

기존(01, 02)에서는 작업자 중심으로 기획했으나, 실제 운영 흐름은:
1. 관리자/소장이 프로젝트 생성 (공사 기본 정보 입력)
2. 프로젝트에 현장(Site), 협력사(Company), 공정(Work Process) 등록
3. 안전관리자가 일일 위험지역 설정
4. 작업자 투입 후 작업 시작 → 실시간 안전 정보 수신

==============================================================
1. 핵심 개념
==============================================================

1.1 미니 안전 PMIS (5억~10억 규모 프로젝트 대상)

기존 PMIS(Primavera, MS Project 등)는 복잡하고 무겁습니다.
Safe-On은 "안전 중심의 경량 PMIS"로, 다음만 관리합니다:

- 프로젝트 기본 정보 (공사명, 위치, 회사, 공정, 기간, 금액)
- 일일 위험지역 (안전관리자가 실시간 변경)
- 작업자 위치와 위험지역 매칭 → 자동 경고
- 실시간 진행도, 공지, 안전 정보 (작업자 개인 맞춤)

1.2 데이터 흐름 우선순위

(1순위) Project 생성 (관리자)
    ↓
(2순위) 현장/협력사/공정/구역 등록 (관리자)
    ↓
(3순위) 일일 위험지역 설정 (안전관리자)
    ↓
(4순위) 작업자 투입 및 작업 시작
    ↓
(5순위) 실시간 모니터링 및 경고

==============================================================
2. 사용자 역할 및 권한
==============================================================

2.1 역할 구분

(소장/관리자 - Manager)
- 프로젝트 생성 및 기본 정보 설정
- 현장(Site), 협력사(Company), 공정(Work Process) 등록
- 전체 현황 대시보드 조회

(안전관리자 - Safety Manager)
- 일일 위험지역 실시간 변경
- 작업자 배정 및 작업 승인
- 위험도 기반 경고 발송
- 안전 점검 및 로그 관리

(작업자 - Worker)
- 오늘의 작업 확인 (내 작업 위치, 위험지역)
- 실시간 위험 경고 수신
- 안전 교육 이수 (30초 브리핑)
- 사고/아차사고 신고

2.2 권한 매트릭스

(기능)                    (소장)   (안전관리자)   (작업자)
Project 생성/수정           O         X           X
Site/Company 등록          O         △ (보조)     X
일일 위험지역 설정          △         O           X
작업 배정                  △         O           X
작업 시작/종료              X         X           O
위험 신고                  △         O           O
대시보드 조회              O         O           △ (본인 정보만)

==============================================================
3. 핵심 기능 재정의 (관리자 → 작업자 순서)
==============================================================

3.1 Phase 1: 관리자 설정 (프로젝트 구축)

(F1-1) 프로젝트 생성 *최우선*
  - 공사명, 위치(주소/좌표), 발주처, 시공사
  - 공사 기간 (착공일~준공일)
  - 공사 금액 (예산)
  - 공사 유형 (신축/리모델링/토목 등)
  - 담당 소장 및 안전관리자 지정

(F1-2) 현장(Site) 및 구역(Zone) 등록
  - 현장 내 작업 구역 설정: 층별(1F, 2F, 지하 등)
  - 구역별 타입 (실내/실외/옥상/PIT/위험구역)
  - 구역별 고정 위험 요소 (추락, 환기불량 등)

(F1-2-1) 작업 위치 설정 (중간관리자) *신규 흐름*
  - 중간관리자가 [작업 관리] 또는 [작업 위치] 탭 진입
  - 현재 프로젝트 위치 좌표가 지도에 표시됨 (Project의 location_lat, location_lng 기반)
  - 그 위치 기반으로 작업 구역(Zone) 등록/수정:
    · 위도·경도 (lat, lng) — 지도 클릭 또는 직접 입력
    · 층/구역 (level: 1F, B1, ROOF 등), 구역명 (name: 1Room, A구역 등)
    · 타입 (INDOOR, OUTDOOR, ROOF, PIT, DANGER), 특징 (default_hazards)
  - Zone 테이블 기준으로 위도·경도만 추가 설정 가능 (이미 level, name, type, default_hazards 존재)
  - 구역 등록 후 → [일일 작업 계획]에서 등록된 구역 + DB 작업 목록(템플릿)을 조합해 근무자에게 위치·작업 배분
  - 작업자: 등록된 위치(구역)와 배정된 작업을 앱에서 확인

(F1-3) 협력사(Company) 등록
  - 협력사명, 주 공종
  - 협력사별 투입 인력 리스트 (Worker)

(F1-4) 공정(Work Process) 템플릿 등록
  - 공종별 작업 템플릿 (거푸집, 용접, 고소작업 등)
  - 각 작업별 기본 위험도, 필수 보호구, 점검 항목

---

3.2 Phase 2: 안전관리자 일일 운영

(F2-1) 일일 위험지역 설정 *핵심*
  - 매일 아침, 안전관리자가 "오늘의 위험지역" 설정
  - 중장비 작업 위치, 화재 위험, 낙하물 위험 등
  - 작업자가 해당 구역에 접근 시 자동 경고

(F2-2) 작업 배정 (Daily Work Plan)
  - 오늘의 작업 등록: 구역 + 공종 + 작업자 배정
  - 작업별 위험도 자동 계산 (Risk Engine)
  - 고위험 작업(70점 이상) 시 필수 점검/교육 강제

(F2-3) 작업 승인 및 모니터링
  - 작업 시작 전 안전 점검 확인
  - 실시간 작업 현황 모니터링 (진행/완료)
  - 위험 상황 발생 시 긴급 지시

(F2-4) 데일리 흐름 요약 (프로젝트 위치 → 작업자 노출)
  - 프로젝트 생성 시: 현장 위치(주소/좌표)만 저장. 도면/구역은 프로젝트 상세 또는 매니저 [작업 위치]에서 등록.
  - 중간관리자가 [작업 위치]에서 구역(층, 구역명, 좌표, 타입, 특징) 등록 후, "일일 작업 계획"에서:
    (1) 작업 위치: 구역(Zone) 선택 + 공종(템플릿) + 작업자 배정
    (2) 그날 위험요소: 해당 작업의 일일 위험(daily_hazards) 입력 (예: 화재위험, 낙하물 주의)
    (3) 일일 변동 위험 구역(DailyDangerZone): 특정 구역에 오늘만 해당하는 위험 등록 (중장비, 화재 등)
  - 작업자 앱: "금일 나의 작업"에서 작업 위치(구역명) + 그날 위험요소(구역 고정 + daily_hazards + 일일 변동 위험)를 자동으로 확인.

---

3.3 Phase 3: 작업자 앱 사용

(F3-1) 오늘의 작업 확인
  - 앱 실행 → "오늘 내 작업" 자동 표시
  - 작업 위치(Zone), 작업 내용, 위험 요소 확인

(F3-2) 실시간 위험 경고
  - 내 작업 위치와 일일 위험지역 매칭
  - 위험지역 접근 시 자동 알림 (팝업/진동)
  - 위험도(Low/Medium/High) 색상 표시

(F3-3) 안전 교육 (30초 브리핑)
  - 작업 시작 버튼 누르면 자동 브리핑 노출
  - "오늘의 위험: 크레인 작업 중, 상부 낙하물 주의"
  - 교육 이수 로그 자동 저장

(F3-4) 위험 신고 (One-Touch)
  - 작업 중 위험 상황 발견 시 원터치 신고
  - 위치, 사진, 간단한 코멘트만 입력
  - 안전관리자에게 실시간 전송

==============================================================
4. 데이터베이스 스키마 설계 (Project-Centric)
==============================================================

4.1 ERD 구조 (최상위 → 하위)

[Project] (최상위 - 신규 테이블)
    |
    ├── [Sites] (프로젝트 내 현장들)
    |     └── [Zones] (현장 내 구역들)
    |           └── [DailyWorkPlans] (일일 작업 계획)
    |                 └── [WorkerAllocations] (작업자 배정)
    |
    ├── [Companies] (협력사들)
    |     └── [Workers] (작업자들)
    |
    └── [WorkTemplates] (공정 템플릿 라이브러리)

보조 테이블:
- [DailyDangerZones] (일일 위험지역)
- [SafetyLogs] (안전 점검/사고 로그)
- [Notices] (공지사항)
- [Attendance] (출역 기록)

---

4.2 신규 테이블: Project (프로젝트)

필드명                 타입            설명
--------------------------------------------------------------
id                    Integer         기본키
name                  String          공사명 (예: OO아파트 신축공사)
location_address      String          공사 위치 (주소)
location_lat          Float           위도 (지도용)
location_lng          Float           경도 (지도용)

client_company        String          발주처 (예: OO건설)
constructor_company   String          시공사 (예: XX종합건설)

project_type          String          공사 유형 (신축/리모델링/토목 등)
budget_amount         Integer         공사 금액 (원)

start_date            String          착공일 (YYYY-MM-DD)
end_date              String          준공 예정일 (YYYY-MM-DD)

manager_id            Integer(FK)     담당 소장 (users.id)
safety_manager_id     Integer(FK)     안전관리자 (users.id)

status                String          프로젝트 상태 (PLANNED/ACTIVE/DONE)
created_at            DateTime        생성일시

---

4.3 수정된 테이블: Site (현장)

기존 Site 테이블에 project_id 추가:
  project_id  Integer(FK)  프로젝트 ID (projects.id)

하나의 프로젝트에 여러 현장(Site)이 있을 수 있음
(예: 본관 현장, 별관 현장)

---

4.4 수정된 테이블: Company (협력사)

기존 Company 테이블에 project_id 추가:
  project_id  Integer(FK)  프로젝트 ID (projects.id)

협력사는 특정 프로젝트에 소속됨

---

4.5 수정된 테이블: Worker (작업자)

기존 Worker 테이블에 project_id 추가:
  project_id  Integer(FK)  현재 투입된 프로젝트 ID

작업자는 프로젝트 단위로 관리됨
(동일 작업자가 다른 프로젝트에 투입되면 별도 레코드 또는 관계 테이블 필요)

---

4.6 관계 정리 (Relationships)

Project
  └─ has_many Sites (프로젝트는 여러 현장을 가질 수 있음)
  └─ has_many Companies (프로젝트는 여러 협력사를 보유)
  └─ has_many Workers (프로젝트는 여러 작업자를 보유)

Site
  └─ belongs_to Project
  └─ has_many Zones

Zone
  └─ belongs_to Site
  └─ has_many DailyWorkPlans

DailyWorkPlan
  └─ belongs_to Zone
  └─ belongs_to WorkTemplate
  └─ has_many WorkerAllocations

Worker
  └─ belongs_to Project
  └─ belongs_to Company
  └─ has_many WorkerAllocations

==============================================================
5. 구현 우선순위 (Implementation Priority)
==============================================================

5.1 Phase 1: Project 관리 (관리자용) - 최우선

[ ] Project 모델 생성 및 마이그레이션
[ ] Project CRUD API (/api/projects)
    - POST /projects (프로젝트 생성)
    - GET /projects (전체 프로젝트 목록)
    - GET /projects/:id (상세 조회)
    - PUT /projects/:id (수정)

[ ] Project 관리 UI (관리자용)
    - 프로젝트 생성 폼 (기본 정보 입력)
    - 프로젝트 목록 (카드 또는 테이블)
    - 프로젝트 상세 (대시보드)

[ ] Site/Company/Worker에 project_id 추가
    - 기존 테이블 마이그레이션
    - API 수정 (프로젝트 필터링 추가)

---

5.2 Phase 2: 일일 위험지역 설정 (안전관리자용)

[ ] DailyDangerZone 관리 API
    - POST /danger-zones (위험지역 등록)
    - GET /danger-zones?date=YYYY-MM-DD (날짜별 조회)
    - DELETE /danger-zones/:id (삭제)

[ ] 위험지역 지도 표시 UI (안전관리자)
    - 지도 위에 위험지역 표시 (빨간색 마커/영역)
    - 클릭으로 위험지역 추가/삭제

[ ] 작업자-위험지역 매칭 엔진
    - 작업자의 작업 위치(Zone)와 위험지역 비교
    - 일치 시 자동 경고 발송 (Push or Alert)

---

5.3 Phase 3: 작업자 앱 개인 맞춤 정보

[ ] 작업자 대시보드 (오늘의 작업)
    - GET /workers/me/today (내 오늘 작업)
    - 작업 위치, 위험 요소, 위험도 표시

[ ] 실시간 위험 경고 UI
    - 위험지역 접근 시 팝업/배지 표시
    - 위험도별 색상 구분 (Low/Medium/High)

[ ] 안전 브리핑 (30초 교육)
    - 작업 시작 버튼 → 브리핑 팝업
    - 브리핑 내용: 오늘의 위험, 필수 보호구 등
    - 확인 후 작업 시작 가능

==============================================================
6. 추가 고려 사항
==============================================================

6.1 작업자 중복 투입 문제

동일 작업자가 여러 프로젝트에 투입될 경우:
- 방법 1: Worker 테이블에 project_id 없이, ProjectWorker 중간 테이블 생성
- 방법 2: Worker는 User에 종속, ProjectWorker로 프로젝트별 역할 관리

→ 초기에는 "1 작업자 = 1 프로젝트" 가정 (단순화)
→ 추후 필요 시 중간 테이블 추가

6.2 프로젝트 아카이빙 (종료 프로젝트)

프로젝트 상태(status):
- PLANNED: 계획 단계 (아직 착공 전)
- ACTIVE: 진행 중
- DONE: 준공 완료

완료된 프로젝트는 읽기 전용으로 전환, 데이터 보관

6.3 권한 관리 (접근 제어)

사용자(User)는 특정 프로젝트에만 접근 가능:
- 소장/안전관리자: 본인이 담당하는 프로젝트만
- 작업자: 본인이 투입된 프로젝트만

→ API 요청 시 project_id로 필터링 필수

==============================================================
7. 다음 단계 (Next Steps)
==============================================================

1. Project 모델 생성 (back/project/model.py)
2. Alembic 마이그레이션 (테이블 추가)
3. Project CRUD API 구현 (back/project/router.py)
4. 프로젝트 관리 UI 구현 (front/src/features/project)
5. 기존 Site/Company/Worker 테이블에 project_id 추가 (마이그레이션)
6. 작업자 앱: "오늘의 작업" 화면에 프로젝트 정보 반영

==============================================================
마무리
==============================================================

이 아키텍처는 "관리자가 프로젝트를 먼저 설정하고, 작업자들이 사용하는" 
실제 운영 흐름을 반영합니다.

기존 01, 02 기획서의 핵심 기능(위험도 계산, 1분 점검, 30초 교육)은 유지하되,
"프로젝트 중심 데이터 구조"로 재설계하여 실무 적합성을 높였습니다.

다음 작업:
- Project 모델 및 API 구현
- ERD 다이어그램 작성 (시각화)
- 프로젝트 생성 → 작업자 투입 시나리오 테스트
