# ===================================================================
# Nginx 설정 파일 (sogething.com)
# ===================================================================
# 배포 경로: /etc/nginx/sites-available/sogething
# 활성화: /etc/nginx/sites-enabled/sogething (심볼릭 링크)
# 수정 방법: 로컬에서 이 파일 수정 → Git push → deploy.sh 실행
# ===================================================================

# WebSocket Upgrade Map (WebSocket 지원 필수 설정)
# WebSocket 연결 시 HTTP Upgrade 헤더를 올바르게 처리하기 위한 맵
# - Upgrade 헤더가 있으면 "upgrade"로 전달
# - 헤더가 없으면 "close"로 설정하여 일반 HTTP 요청 처리
map $http_upgrade $connection_upgrade {
    default upgrade;  # Upgrade 헤더 존재 시
    '' close;         # Upgrade 헤더 없을 시
}

# ===================================================================
# HTTP 서버 블록 (포트 80)
# ===================================================================
# 역할: HTTP 요청을 HTTPS로 리다이렉트
# 보안: 암호화되지 않은 연결이므로 최종적으로 HTTPS로 전환됨
server {
    listen 80;  # HTTP 포트
    server_name sogething.com www.sogething.com;

    # 프론트엔드 (React/Vite dev server)
    # 모든 일반 페이지 요청을 Vite dev 서버로 전달
    location / {
        proxy_pass http://localhost:3000;  # Vite dev server
        proxy_http_version 1.1;            # HTTP/1.1 사용 (WebSocket 필수)
        
        # WebSocket 지원 헤더
        proxy_set_header Upgrade $http_upgrade;              # WebSocket Upgrade 전달
        proxy_set_header Connection $connection_upgrade;     # Connection 헤더 조건부 설정
        
        # 기본 프록시 헤더
        proxy_set_header Host $host;                         # 원본 Host 헤더 유지
        proxy_cache_bypass $http_upgrade;                    # WebSocket 요청 캐시 우회
    }

    # 백엔드 API (FastAPI)
    # /api/로 시작하는 모든 요청을 FastAPI 서버로 전달
    location /api/ {
        proxy_pass http://localhost:8400;  # FastAPI uvicorn server
        proxy_http_version 1.1;            # HTTP/1.1 사용 (WebSocket 필수)
        
        # WebSocket 지원 헤더
        proxy_set_header Upgrade $http_upgrade;              # WebSocket Upgrade 전달
        proxy_set_header Connection $connection_upgrade;     # Connection 헤더 조건부 설정
        
        # 기본 프록시 헤더
        proxy_set_header Host $host;                         # 원본 Host 유지
        proxy_set_header X-Real-IP $remote_addr;             # 클라이언트 실제 IP 전달
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 프록시 체인 IP 목록
        proxy_set_header X-Forwarded-Proto $scheme;          # 원본 프로토콜 (http/https) 전달
    }
}



# ===================================================================
# HTTPS 서버 블록 (포트 443)
# ===================================================================
# 역할: SSL/TLS 암호화 연결 처리 (Let's Encrypt 인증서 사용)
# 보안: 모든 프로덕션 트래픽이 이 블록을 통과
server {
    server_name sogething.com www.sogething.com;

    # 프론트엔드 (Vite/React)
    # HTTPS로 접속한 모든 페이지 요청 처리
    location / {
        proxy_pass http://localhost:3000;  # 프론트엔드 서버
        proxy_http_version 1.1;            # HTTP/1.1 필수
        
        # WebSocket 지원 (HMR, 게임 소켓 등)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # 프록시 기본 헤더
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 백엔드 API & WebSocket (FastAPI)
    # /api/로 시작하는 모든 요청 (REST API + WebSocket)
    location /api/ {
        proxy_pass http://localhost:8400;  # FastAPI 백엔드
        proxy_http_version 1.1;            # HTTP/1.1 필수
        
        # WebSocket 지원 (게임 WebSocket 등 - CRITICAL!)
        # 이 설정이 없으면 WebSocket 404 발생
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # 프록시 헤더 (클라이언트 정보 전달)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;             # 로깅, 보안용
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;          # FastAPI에서 URL 생성 시 사용
    }

    # Swagger API 문서 (/docs)
    # FastAPI 자동 생성 문서 페이지
    location /docs {
        proxy_pass http://localhost:8400;
        proxy_set_header Host $host;
    }

    # OpenAPI 스키마 (/openapi.json)
    # Swagger가 사용하는 API 스키마 JSON
    location /openapi.json {
        proxy_pass http://localhost:8400;
    }

    # SSL 설정 (Let's Encrypt Certbot 자동 관리)
    listen 443 ssl;                                                       # HTTPS 포트
    ssl_certificate /etc/letsencrypt/live/sogething.com/fullchain.pem;   # 공개 인증서
    ssl_certificate_key /etc/letsencrypt/live/sogething.com/privkey.pem; # 개인 키
    include /etc/letsencrypt/options-ssl-nginx.conf;                      # Certbot SSL 옵션
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;                        # Diffie-Hellman 파라미터
}

# ===================================================================
# HTTP → HTTPS 리다이렉트 서버 블록
# ===================================================================
# 역할: 포트 80으로 들어온 요청을 HTTPS로 강제 리다이렉트
# 예: http://sogething.com → https://sogething.com
server {
    # Certbot이 자동 생성한 리다이렉트 규칙
    if ($host = www.sogething.com) {
        return 301 https://$host$request_uri;  # 301 영구 리다이렉트
    }

    if ($host = sogething.com) {
        return 301 https://$host$request_uri;
    }

    listen 80;
    server_name sogething.com www.sogething.com;
    return 404;  # 위 조건에 맞지 않으면 404 (비정상 요청)
}

