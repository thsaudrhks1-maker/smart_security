---
name: Database Lifecycle Manager
description: DB 스키마 의존성 관리, 시딩(Seeding) 순서, 마이그레이션(Alembic) 워크플로우를 담당하는 스킬.
---

# Database Lifecycle Manager

본 스킬은 프로젝트의 데이터베이스 생애주기 전반을 관리하며, 특히 상무님 등 주요 의사결정자에게 보여줄 데모 데이터를 생성하는 규칙을 정의합니다.

## 0. 테이블 명명 규칙 (Table Naming Convention)

### 참조 테이블 (Junction Table) 규칙
Many-to-Many 관계의 중간 테이블은 **`_links`** 접미사를 필수로 사용합니다.

**형식:**
```
{entity1}_{entity2}_links
```

**예시:**
- ✅ `daily_worker_links` (작업일보 ↔ 작업자)
- ✅ `project_user_links` (프로젝트 ↔ 사용자)
- ✅ `zone_danger_links` (구역 ↔ 위험요소)
- ❌ `daily_worker_allocations` (너무 김, 금지)
- ❌ `project_members` (불명확, 금지)

**이유:**
- 간결성: 테이블명이 짧아야 쿼리 가독성이 높아짐
- 일관성: 모든 참조 테이블이 `_links`로 끝나면 DB 스키마 파악이 쉬움
- 명확성: "이 테이블은 두 엔티티를 연결하는 테이블이구나"를 즉시 인지 가능

## 1. 개요
데이터베이스의 일관성을 유지하고, 개발 및 데모 환경에서 즉시 사용 가능한 풍부한 데이터를 공급하는 것을 목표로 합니다.

## 2. 시딩(Seeding) 가이드
- **위치:** 모든 테스트 및 시딩 스크립트는 루트 디렉토리의 `script_test/` 폴더 내에 보관합니다.
- **실행 방식:** 패키지 모듈 방식 대신 직접 실행 가능하도록 `sys.path` 설정을 포함해야 합니다.
- **데이터 품질:** 
    - 실제 현장 용어 사용 (예: '작업1' 금지, '지하 1층 환기 덕트 설치' 권장)
    - 시간 데이터는 항상 실행 시점의 `today()`와 동기화
- **정합성 유지:** 데이터 삽입 전 반드시 `fix_sequence`를 통해 PostgreSQL ID 시퀀스를 초기화합니다.

## 3. DB 설계 및 테이블 생성 원칙 (필독)
에이전트는 새로운 기능을 구현하거나 스키마를 수정할 때 다음 원칙을 반드시 준수합니다.
- **참조 테이블 원칙:** 다른 테이블의 ID(Foreign Key) 목록을 저장해야 할 경우, **JSON 배열을 사용하지 않고 반드시 다대다(M:N) 매핑 테이블을 생성**합니다. (예: `required_ppe`를 JSON으로 넣는 대신 `template_resource_map` 테이블 사용)
- **JSONB 사용 제한:** JSON 데이터 타입은 다음의 경우에만 예외적으로 허용합니다.
    1. 필드 구성이 극히 유동적인 메타데이터 (예: 센서 로그의 로우 데이터)
    2. 단순 텍스트 설명의 집합 (참조가 필요 없는 단순 코멘트 리스트 등)
- **데이터 무결성:** 참조 테이블 생성 시 반드시 `FOREIGN KEY` 제약 조건을 걸어 데이터 정합성을 보장합니다.
- **정규화:** 제3정규화까지 고려하여 중복 데이터를 최소화합니다.

## 3. 마이그레이션 규칙 (Alembic)
- 스키마 변경 시 반드시 `alembic revision --autogenerate`를 통해 이력을 관리합니다.
- 새로운 테이블 추가 시 `back/database.py`의 하단 모델 임포트 리스트에 반드시 등록해야 합니다.

## 4. 주요 스크립트 명세
- `script_test/master_data.py`: 업체, 공종 템플릿 등 기초 마스터 정보 주입
- `script_test/scenario_seeder.py`: 특정 인물(강공남 등) 중심의 일일 현장 시나리오 생성
